name: Claude Documentation Generator

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Get changed code files
        id: changed_files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get list of changed files
          gh pr diff ${{ github.event.pull_request.number }} --name-only > changed_files.txt

          # Filter for code files (js, jsx, ts, tsx, but exclude test files)
          grep -E '\.(js|jsx|ts|tsx)$' changed_files.txt | grep -v -E '\.(test|spec)\.(js|jsx|ts|tsx)$' > code_files.txt || true

          # Check if we have any code files to document
          if [ -s code_files.txt ]; then
            echo "has_code_files=true" >> $GITHUB_OUTPUT
            echo "Code files found:"
            cat code_files.txt
          else
            echo "has_code_files=false" >> $GITHUB_OUTPUT
            echo "No code files to document"
          fi

      - name: Analyze files and generate documentation
        if: steps.changed_files.outputs.has_code_files == 'true'
        id: generate_docs
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read the list of changed code files
          CODE_FILES=$(cat code_files.txt)

          # Initialize documentation suggestions
          DOCS_SUGGESTIONS=""

          # Process each file
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Processing $file..."

              # Get the full diff for this file using git diff with the PR base
              FILE_DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "$file")

              # Get the current file content
              FILE_CONTENT=$(cat "$file")

              # Create prompt for Claude
              PROMPT="You are a technical documentation expert. Analyze this code file and its changes, then suggest documentation updates.

          File: $file

          Current file content:
          \`\`\`
          $FILE_CONTENT
          \`\`\`

          Recent changes (diff):
          \`\`\`
          $FILE_DIFF
          \`\`\`

          Please provide:
          1. A brief description of what this file does (1-2 sentences)
          2. Key functions/components and their purposes
          3. Any important usage notes or examples
          4. Suggested documentation updates based on the changes

          Format your response as markdown that could be added to a documentation file."

              # Call Claude API
              RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
                -H "content-type: application/json" \
                -H "x-api-key: $ANTHROPIC_API_KEY" \
                -H "anthropic-version: 2023-06-01" \
                -d "{
                  \"model\": \"claude-sonnet-4-5-20250929\",
                  \"max_tokens\": 2048,
                  \"messages\": [{
                    \"role\": \"user\",
                    \"content\": $(echo "$PROMPT" | jq -Rs .)
                  }]
                }")

              # Extract the documentation from the response
              DOC=$(echo "$RESPONSE" | jq -r '.content[0].text')

              # Add to suggestions
              DOCS_SUGGESTIONS="$DOCS_SUGGESTIONS

          ### \`$file\`

          $DOC

          ---
          "
            fi
          done < code_files.txt

          # Save suggestions to file
          echo "$DOCS_SUGGESTIONS" > docs_suggestions.txt

      - name: Post documentation suggestions
        if: steps.changed_files.outputs.has_code_files == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUGGESTIONS=$(cat docs_suggestions.txt)

          # Create comment body
          COMMENT_BODY="## ðŸ“š Claude Documentation Suggestions

          Claude has analyzed the code changes in this PR and generated the following documentation suggestions:

          $SUGGESTIONS

          ---
          *Generated by Claude - Review and adapt these suggestions as needed for your documentation*"

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$COMMENT_BODY"

      - name: No code files to document
        if: steps.changed_files.outputs.has_code_files == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "No code files found that need documentation. Skipping..."
