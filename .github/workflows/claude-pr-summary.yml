name: Claude PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Get PR diff
        id: pr_diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the diff for this PR
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

          # Check if diff is too large (Claude has token limits)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            echo "diff_too_large=true" >> $GITHUB_OUTPUT
          else
            echo "diff_too_large=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate summary with Claude
        if: steps.pr_diff.outputs.diff_too_large == 'false'
        id: claude_summary
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff
          DIFF=$(cat pr_diff.txt)

          # Create the prompt for Claude
          PROMPT="Please analyze this pull request diff and provide a concise summary. Include:
          1. A brief overview of the main changes
          2. Key files or components modified
          3. Any notable patterns or concerns

          Keep the summary focused and helpful for code reviewers.

          Here's the diff:

          $DIFF"

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-5-20250929\",
              \"max_tokens\": 1024,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $(echo "$PROMPT" | jq -Rs .)
              }]
            }")

          # Extract the summary from the response
          SUMMARY=$(echo "$RESPONSE" | jq -r '.content[0].text')

          # Save to file for next step
          echo "$SUMMARY" > summary.txt

      - name: Post summary comment
        if: steps.pr_diff.outputs.diff_too_large == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUMMARY=$(cat summary.txt)

          # Create comment body with Claude branding
          COMMENT_BODY="## ðŸ¤– Claude PR Summary

$SUMMARY

---
*Generated by Claude*"

          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$COMMENT_BODY"

      - name: Comment if diff too large
        if: steps.pr_diff.outputs.diff_too_large == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ðŸ¤– Claude PR Summary

Unable to generate summary - the PR diff is too large to analyze. Consider breaking this PR into smaller changes."
