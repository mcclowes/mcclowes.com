name: Spellcheck Markdown Files

on:
  pull_request:
    paths:
      - 'blog/**/*.md' # Trigger only when blog Markdown files are changed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  spellcheck:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository with full history
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full Git history

      # Step 2: Install cspell
      - name: Install cspell
        run: |
          npm install -g cspell

      # Step 3: Get list of changed Markdown files
      - name: List changed Markdown files
        id: changed_files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          echo "Comparing against base SHA: $BASE_SHA"
          CHANGED_FILES=$(git diff --name-only $BASE_SHA | grep '^blog/.*\.md$' || echo "")
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

      # Step 4: Run spellcheck on changed files
      - name: Run cspell
        if: env.CHANGED_FILES != ''
        id: spellcheck
        run: |
          echo "Files to check: $CHANGED_FILES"
          cspell $CHANGED_FILES 2>&1 | tee spellcheck-result.txt || true
          if grep -q "Unknown word" spellcheck-result.txt; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      # Step 5: Post spellcheck results as a PR comment
      - name: Comment on PR with spellcheck results
        if: env.CHANGED_FILES != '' && steps.spellcheck.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('spellcheck-result.txt', 'utf8');

            const output = `### üìù Spellcheck Results

            **Checked files:** \`${process.env.CHANGED_FILES}\`

            **Spelling issues found:**
            \`\`\`
            ${result.trim()}
            \`\`\`

            üí° *Add words to \`.cspell.json\` if they are valid technical terms or proper nouns.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      # Step 6: Fail if spelling errors found
      - name: Fail if spelling errors
        if: env.CHANGED_FILES != '' && steps.spellcheck.outputs.has_errors == 'true'
        run: |
          echo "‚ùå Spellcheck failed. Please fix the spelling errors above."
          exit 1
