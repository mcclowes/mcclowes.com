name: Broken Links Check

on:
  schedule:
    - cron: '0 9 * * 1' # Runs weekly on Monday at 9am UTC
  workflow_dispatch: # Allows manual triggering from the GitHub UI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  link-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install linkinator
        run: npm install -g linkinator

      - name: Run linkinator
        run: npx linkinator https://mcclowes.com --recurse --retry --verbosity error --skip ".*github.*" --skip ".*linkedin.com.*" --format json > link-results.json
        continue-on-error: true # Ensure the workflow continues even if linkinator finds broken links

      - name: Process Results and Create Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('link-results.json', 'utf8'));
            const filtered = results.links
              .filter(link => link.status !== 403 && link.status !== 429 && link.status !== 500 && link.status !== 0)

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueTitle = 'Broken Links Report';

            // Find existing issue
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'broken-links',
            });
            const existingIssue = issues.data.find(issue => issue.title === issueTitle);

            if (filtered.length > 0) {
              const printList = filtered.map(link => `- [${link.status}] ${link.url}`).join('\n');
              const body = `## Broken Links Found\n\nThe weekly link check found the following broken links:\n\n${printList}\n\n---\n*This issue is automatically updated by the weekly link check workflow.*`;

              if (existingIssue) {
                // Update existing issue
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existingIssue.number,
                  body,
                });
                console.log(`Updated issue #${existingIssue.number}`);
              } else {
                // Create new issue
                await github.rest.issues.create({
                  owner,
                  repo,
                  title: issueTitle,
                  body,
                  labels: ['broken-links'],
                });
                console.log('Created new broken links issue');
              }
              core.setFailed('There are broken links in the documentation.');
            } else {
              console.log('No broken links found!');
              if (existingIssue) {
                // Close existing issue since no more broken links
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existingIssue.number,
                  state: 'closed',
                  state_reason: 'completed',
                });
                console.log(`Closed issue #${existingIssue.number} - no more broken links`);
              }
            }
